<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>InfoGares - Metz</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #000;
            color: #fff;
        }

        .top-bar {
            background: #1a1a1a;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #ffcc00;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #ffcc00;
        }

        .clock-display {
            font-size: 24px;
            font-weight: bold;
            color: #ffcc00;
            font-family: monospace;
        }

        .station-selector {
            background: #2a2a2a;
            padding: 15px 30px;
            border-bottom: 2px solid #444;
        }

        .station-selector select {
            padding: 8px 15px;
            font-size: 16px;
            background: #000;
            color: #ffcc00;
            border: 2px solid #ffcc00;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .station-selector label {
            margin-right: 10px;
            font-size: 16px;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #000;
        }

        thead {
            background: #1a1a1a;
        }

        th {
            padding: 12px 15px;
            text-align: left;
            font-size: 13px;
            font-weight: bold;
            color: #ffcc00;
            border-bottom: 2px solid #ffcc00;
            text-transform: uppercase;
        }

        tbody tr {
            border-bottom: 1px solid #333;
        }

        tbody tr:hover {
            background: #1a1a1a;
        }

        td {
            padding: 15px;
            font-size: 16px;
            vertical-align: middle;
        }

        .status-col {
            width: 120px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            text-align: center;
        }

        .status-ontime {
            background: #00aa00;
            color: white;
        }

        .status-delayed {
            background: #ff3333;
            color: white;
        }

        .train-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .train-type {
            background: #0066cc;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .train-type.tgv {
            background: #8b0000;
        }

        .train-type.ter {
            background: #0066cc;
        }

        .train-number {
            font-weight: bold;
            font-size: 18px;
        }

        .destination {
            font-size: 18px;
            font-weight: 500;
        }

        .time-display {
            font-family: monospace;
            font-size: 22px;
            font-weight: bold;
        }

        .time-real {
            color: #ffcc00;
        }

        .delay-info {
            font-weight: bold;
            font-size: 16px;
        }

        .delay-red {
            color: #ff3333;
        }

        .delay-green {
            color: #00ff00;
        }

        .platform {
            font-size: 32px;
            font-weight: bold;
            color: #ffcc00;
            text-align: center;
        }

        .info-flash {
            background: #1a1a1a;
            border-top: 3px solid #ffcc00;
            padding: 15px 30px;
            margin-top: 0;
            overflow: hidden;
        }

        .info-flash-title {
            color: #ffcc00;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .info-flash-content {
            color: #fff;
            font-size: 14px;
            animation: scroll-left 25s linear infinite;
            white-space: nowrap;
        }

        @keyframes scroll-left {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(-100%);
            }
        }

        .empty {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .error {
            background: #ff3333;
            padding: 15px 30px;
            display: none;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #ffcc00;
            font-size: 18px;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="logo">InfoGares</div>
    <div class="clock-display" id="clock"></div>
</div>

<div class="station-selector">
    <label>GARE :</label>
    <select id="stationChange" onchange="changeStation()">
        <option value="stop_area:SNCF:87212407">METZ-VILLE</option>
        <option value="stop_area:SNCF:87212415">NOVEANT-SUR-MOSELLE</option>
        <option value="stop_area:SNCF:87212381">ANCY-SUR-MOSELLE</option>
        <option value="stop_area:SNCF:87212399">ARS-SUR-MOSELLE</option>
    </select>
</div>

<div id="error" class="error"></div>

<table>
    <thead>
        <tr>
            <th class="status-col">STATUT</th>
            <th>TRAIN</th>
            <th>DESTINATION</th>
            <th>HEURE</th>
            <th>RETARD</th>
            <th>VOIE</th>
        </tr>
    </thead>
    <tbody id="trains">
        <tr><td colspan="6" class="loading">Chargement des donnees en temps reel...</td></tr>
    </tbody>
</table>

<div class="info-flash">
    <div class="info-flash-title">Informations Flash</div>
    <div class="info-flash-content" id="infoFlash">
        Bienvenue sur InfoGares - Informations en temps reel - Pensez a valider votre titre de transport avant de monter a bord
    </div>
</div>

<script>
var clientId = 'a5e9fa79d1014e67919fd6f4f91269f5';
var clientSecret = '75238a1e08824fc9a5f2dce357a9683c';
var accessToken = '';
var stationCode = 'stop_area:SNCF:87212407';
var timer = null;

function getToken(callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'https://api.sncf.com/v1/token', true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    
    var authString = clientId + ':' + clientSecret;
    var encodedAuth = btoa(authString);
    xhr.setRequestHeader('Authorization', 'Basic ' + encodedAuth);
    
    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                accessToken = data.access_token;
                if (callback) callback();
            } else {
                document.getElementById('error').innerHTML = 'Erreur authentification API';
                document.getElementById('error').style.display = 'block';
            }
        }
    };
    
    xhr.send('grant_type=client_credentials');
}

function changeStation() {
    stationCode = document.getElementById('stationChange').value;
    refresh();
}

function refresh() {
    if (!accessToken) {
        getToken(refresh);
        return;
    }
    
    var url = 'https://api.sncf.com/v1/coverage/sncf/stop_areas/' + stationCode + '/departures?count=15';

    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);

    xhr.onreadystatechange = function() {
        if (xhr.readyState == 4) {
            if (xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                if (data.departures && data.departures.length > 0) {
                    show(data.departures);
                    updateInfoFlash(data.disruptions);
                } else {
                    document.getElementById('trains').innerHTML = '<tr><td colspan="6" class="empty">Aucun depart prevu</td></tr>';
                }
                document.getElementById('error').style.display = 'none';
            } else if (xhr.status == 401) {
                accessToken = '';
                getToken(refresh);
            } else {
                document.getElementById('error').innerHTML = 'Erreur chargement donnees';
                document.getElementById('error').style.display = 'block';
            }
        }
    };

    xhr.send();
}

function show(deps) {
    var html = '';

    for (var i = 0; i < deps.length; i++) {
        var d = deps[i];
        var t1 = new Date(d.stop_date_time.base_departure_date_time);
        var t2 = new Date(d.stop_date_time.departure_date_time);
        var delay = Math.floor((t2.getTime() - t1.getTime()) / 60000);

        var trainNum = d.display_informations.headsign || 'N/A';
        var trainType = 'TER';
        if (trainNum.indexOf('TGV') >= 0) {
            trainType = 'TGV';
        } else if (trainNum.indexOf('IC') >= 0) {
            trainType = 'IC';
        }

        var dest = d.display_informations.direction || 'Inconnu';
        var voie = '-';
        if (d.stop_point && d.stop_point.name) {
            voie = d.stop_point.name.replace('Voie ', '');
        }

        var statusBadge = '<span class="status-badge status-ontime">A l\'heure</span>';
        if (delay > 0) {
            statusBadge = '<span class="status-badge status-delayed">Retarde</span>';
        }

        var delayTxt = '-';
        var delayClass = 'delay-green';
        if (delay > 0) {
            delayTxt = '+' + delay + ' min';
            delayClass = 'delay-red';
        } else if (delay < 0) {
            delayTxt = delay + ' min';
        }

        var typeClass = trainType.toLowerCase();

        html = html + '<tr>';
        html = html + '<td class="status-col">' + statusBadge + '</td>';
        html = html + '<td><div class="train-info"><span class="train-type ' + typeClass + '">' + trainType + '</span><span class="train-number">' + trainNum + '</span></div></td>';
        html = html + '<td><span class="destination">' + dest + '</span></td>';
        html = html + '<td><span class="time-display time-real">' + formatTime(t2) + '</span></td>';
        html = html + '<td><span class="delay-info ' + delayClass + '">' + delayTxt + '</span></td>';
        html = html + '<td><span class="platform">' + voie + '</span></td>';
        html = html + '</tr>';
    }

    document.getElementById('trains').innerHTML = html;
}

function updateInfoFlash(disruptions) {
    var infoText = 'Bienvenue sur InfoGares - Informations en temps reel - ';
    
    if (disruptions && disruptions.length > 0) {
        var maxItems = disruptions.length;
        if (maxItems > 3) {
            maxItems = 3;
        }
        for (var i = 0; i < maxItems; i++) {
            if (disruptions[i].messages && disruptions[i].messages.length > 0) {
                infoText = infoText + disruptions[i].messages[0].text + ' - ';
            }
        }
    }
    
    infoText = infoText + 'Pensez a valider votre titre de transport avant de monter a bord - ';
    
    document.getElementById('infoFlash').innerHTML = infoText;
}

function formatTime(d) {
    var h = d.getHours();
    var m = d.getMinutes();
    if (h < 10) {
        h = '0' + h;
    }
    if (m < 10) {
        m = '0' + m;
    }
    return h + ':' + m;
}

function updateClock() {
    var n = new Date();
    var h = n.getHours();
    var m = n.getMinutes();
    var s = n.getSeconds();
    if (h < 10) {
        h = '0' + h;
    }
    if (m < 10) {
        m = '0' + m;
    }
    if (s < 10) {
        s = '0' + s;
    }
    var el = document.getElementById('clock');
    if (el) {
        el.innerHTML = h + ':' + m + ':' + s;
    }
}

getToken(function() {
    refresh();
    timer = setInterval(refresh, 30000);
});

setInterval(updateClock, 1000);
updateClock();
</script>

</body>
</html>