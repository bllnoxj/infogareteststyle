<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InfoGares Metz</title>
<style>
body {
margin: 0;
padding: 0;
font-family: Arial, sans-serif;
background: #000;
color: #fff;
}

.top-bar {
background: #1a1a1a;
padding: 15px 30px;
display: flex;
justify-content: space-between;
align-items: center;
border-bottom: 3px solid #ffc800;
}

.logo {
font-size: 32px;
font-weight: bold;
color: #ffc800;
}

.clock {
font-size: 28px;
font-weight: bold;
color: #ffc800;
font-family: monospace;
}

.station-bar {
background: #2a2a2a;
padding: 12px 30px;
border-bottom: 2px solid #444;
}

.station-bar label {
font-size: 16px;
font-weight: bold;
margin-right: 10px;
}

.station-bar select {
padding: 10px 20px;
font-size: 16px;
background: #000;
color: #ffc800;
border: 2px solid #ffc800;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
}

.trains-table {
width: 100%;
border-collapse: collapse;
}

.trains-table thead {
background: #1a1a1a;
}

.trains-table th {
padding: 15px;
text-align: left;
font-size: 14px;
font-weight: bold;
color: #ffc800;
border-bottom: 2px solid #ffc800;
text-transform: uppercase;
}

.trains-table tbody tr {
border-bottom: 1px solid #333;
transition: background 0.2s;
}

.trains-table tbody tr:hover {
background: #1a1a1a;
}

.trains-table td {
padding: 18px 15px;
font-size: 16px;
}

.status-badge {
display: inline-block;
padding: 6px 14px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
text-transform: uppercase;
}

.badge-ok {
background: #00aa00;
color: white;
}

.badge-late {
background: #ff3333;
color: white;
}

.train-info {
display: flex;
align-items: center;
gap: 10px;
}

.train-type {
padding: 5px 10px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
color: white;
}

.type-ter {
background: #0066cc;
}

.type-tgv {
background: #8b0000;
}

.train-num {
font-size: 20px;
font-weight: bold;
}

.destination {
font-size: 18px;
}

.time {
font-family: monospace;
font-size: 24px;
font-weight: bold;
color: #ffc800;
}

.delay {
font-size: 18px;
font-weight: bold;
}

.delay-red {
color: #ff3333;
}

.delay-green {
color: #00ff00;
}

.platform {
font-size: 32px;
font-weight: bold;
color: #ffc800;
text-align: center;
}

.info-flash {
background: #1a1a1a;
border-top: 3px solid #ffc800;
padding: 15px 30px;
overflow: hidden;
}

.info-title {
color: #ffc800;
font-weight: bold;
font-size: 14px;
margin-bottom: 8px;
}

.info-text {
color: #fff;
font-size: 14px;
white-space: nowrap;
animation: scroll 30s linear infinite;
}

@keyframes scroll {
from { transform: translateX(100%); }
to { transform: translateX(-100%); }
}

.loading {
text-align: center;
padding: 50px;
color: #ffc800;
font-size: 20px;
}

.error {
background: #ff3333;
color: white;
padding: 15px 30px;
display: none;
font-weight: bold;
}
</style>
</head>
<body>

<div class="top-bar">
<div class="logo">InfoGares</div>
<div class="clock" id="clock">--:--:--</div>
</div>

<div class="station-bar">
<label>GARE :</label>
<select id="stationSelect" onchange="changeStation()">
<option value="stop_area:SNCF:87212407">METZ-VILLE</option>
<option value="stop_area:SNCF:87212415">NOVEANT-SUR-MOSELLE</option>
<option value="stop_area:SNCF:87212381">ANCY-SUR-MOSELLE</option>
<option value="stop_area:SNCF:87212399">ARS-SUR-MOSELLE</option>
</select>
</div>

<div id="errorMsg" class="error"></div>

<table class="trains-table">
<thead>
<tr>
<th style="width:120px">STATUT</th>
<th>TRAIN</th>
<th>DESTINATION</th>
<th>HEURE</th>
<th>RETARD</th>
<th style="width:100px;text-align:center">VOIE</th>
</tr>
</thead>
<tbody id="trainsBody">
<tr><td colspan="6" class="loading">Chargement des donnees...</td></tr>
</tbody>
</table>

<div class="info-flash">
<div class="info-title">INFORMATIONS FLASH</div>
<div class="info-text" id="infoText">Bienvenue sur InfoGares - Informations en temps reel</div>
</div>

<script>
var station = 'stop_area:SNCF:87212407';
var apiKey = '02ec645715cd69649a30eaad83c5475e216ca40d202d549478ba5d82';

function changeStation() {
station = document.getElementById('stationSelect').value;
loadTrains();
}

function loadTrains() {
var x = new XMLHttpRequest();
x.open('GET', '/.netlify/functions/trains?station=' + encodeURIComponent(station) + '&key=' + apiKey, true);

x.onload = function() {
if (x.status === 200) {
var d = JSON.parse(x.responseText);
if (d.departures && d.departures.length > 0) {
displayTrains(d.departures);
updateInfo(d.disruptions);
hideError();
} else {
document.getElementById('trainsBody').innerHTML = '<tr><td colspan="6" class="loading">Aucun depart prevu</td></tr>';
}
} else {
showError('Erreur chargement (code: ' + x.status + ')');
document.getElementById('trainsBody').innerHTML = '<tr><td colspan="6" class="loading">Erreur</td></tr>';
}
};

x.onerror = function() {
showError('Erreur connexion');
};

x.send();
}

function displayTrains(trains) {
var html = '';
for (var i = 0; i < trains.length; i++) {
var t = trains[i];
var base = new Date(t.stop_date_time.base_departure_date_time);
var real = new Date(t.stop_date_time.departure_date_time);
var delay = Math.floor((real - base) / 60000);

var num = t.display_informations.headsign || 'N/A';
var type = 'TER';
var typeClass = 'type-ter';
if (num.indexOf('TGV') >= 0) {
type = 'TGV';
typeClass = 'type-tgv';
}

var dest = t.display_informations.direction || 'Inconnu';
var voie = '-';
if (t.stop_point && t.stop_point.name) {
voie = t.stop_point.name.replace('Voie ', '');
}

var status = '<span class="status-badge badge-ok">A l\'heure</span>';
if (delay > 0) {
status = '<span class="status-badge badge-late">Retarde</span>';
}

var delayTxt = '-';
var delayClass = 'delay-green';
if (delay > 0) {
delayTxt = '+' + delay + ' min';
delayClass = 'delay-red';
} else if (delay < 0) {
delayTxt = delay + ' min';
}

html += '<tr>';
html += '<td>' + status + '</td>';
html += '<td><div class="train-info"><span class="train-type ' + typeClass + '">' + type + '</span><span class="train-num">' + num + '</span></div></td>';
html += '<td class="destination">' + dest + '</td>';
html += '<td><span class="time">' + formatTime(real) + '</span></td>';
html += '<td><span class="delay ' + delayClass + '">' + delayTxt + '</span></td>';
html += '<td><span class="platform">' + voie + '</span></td>';
html += '</tr>';
}
document.getElementById('trainsBody').innerHTML = html;
}

function updateInfo(disruptions) {
var txt = 'Bienvenue sur InfoGares - Informations en temps reel - ';
if (disruptions && disruptions.length > 0) {
for (var i = 0; i < 3 && i < disruptions.length; i++) {
if (disruptions[i].messages && disruptions[i].messages[0]) {
txt += disruptions[i].messages[0].text + ' - ';
}
}
}
txt += 'Pensez a valider votre titre de transport - ';
document.getElementById('infoText').innerHTML = txt;
}

function formatTime(d) {
var h = d.getHours();
var m = d.getMinutes();
return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
}

function updateClock() {
var n = new Date();
var h = n.getHours();
var m = n.getMinutes();
var s = n.getSeconds();
document.getElementById('clock').innerHTML = 
(h < 10 ? '0' : '') + h + ':' + 
(m < 10 ? '0' : '') + m + ':' + 
(s < 10 ? '0' : '') + s;
}

function showError(msg) {
document.getElementById('errorMsg').innerHTML = msg;
document.getElementById('errorMsg').style.display = 'block';
}

function hideError() {
document.getElementById('errorMsg').style.display = 'none';
}

loadTrains();
setInterval(loadTrains, 30000);
setInterval(updateClock, 1000);
updateClock();
</script>

</body>
</html>
